<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>3dgs原理及其代码 | Zhiting Li的博客</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="专注分享">
    
    <link rel="preload" href="/blog/assets/css/0.styles.5f88d1cd.css" as="style"><link rel="preload" href="/blog/assets/js/app.831d1050.js" as="script"><link rel="preload" href="/blog/assets/js/7.7a792a4f.js" as="script"><link rel="preload" href="/blog/assets/js/2.01b6400f.js" as="script"><link rel="preload" href="/blog/assets/js/1.0e32e396.js" as="script"><link rel="preload" href="/blog/assets/js/40.abf7f79c.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.323e1776.js"><link rel="prefetch" href="/blog/assets/js/11.2e249cd3.js"><link rel="prefetch" href="/blog/assets/js/14.4b439baf.js"><link rel="prefetch" href="/blog/assets/js/15.e1a9472f.js"><link rel="prefetch" href="/blog/assets/js/16.db552c41.js"><link rel="prefetch" href="/blog/assets/js/17.e81fcc38.js"><link rel="prefetch" href="/blog/assets/js/18.83be574c.js"><link rel="prefetch" href="/blog/assets/js/19.078030fd.js"><link rel="prefetch" href="/blog/assets/js/20.4ee12643.js"><link rel="prefetch" href="/blog/assets/js/21.55b72cb8.js"><link rel="prefetch" href="/blog/assets/js/22.0f6c075e.js"><link rel="prefetch" href="/blog/assets/js/23.786c8180.js"><link rel="prefetch" href="/blog/assets/js/24.fa038b1b.js"><link rel="prefetch" href="/blog/assets/js/25.d8fa8a31.js"><link rel="prefetch" href="/blog/assets/js/26.1e4d6f83.js"><link rel="prefetch" href="/blog/assets/js/27.842916ee.js"><link rel="prefetch" href="/blog/assets/js/28.dc9655af.js"><link rel="prefetch" href="/blog/assets/js/29.d4ada88d.js"><link rel="prefetch" href="/blog/assets/js/3.fc994582.js"><link rel="prefetch" href="/blog/assets/js/30.273146f8.js"><link rel="prefetch" href="/blog/assets/js/31.430eac79.js"><link rel="prefetch" href="/blog/assets/js/32.5f5ff60a.js"><link rel="prefetch" href="/blog/assets/js/33.df15770d.js"><link rel="prefetch" href="/blog/assets/js/34.2a7572c8.js"><link rel="prefetch" href="/blog/assets/js/35.a53ffaf7.js"><link rel="prefetch" href="/blog/assets/js/36.6f990377.js"><link rel="prefetch" href="/blog/assets/js/37.d1889e3b.js"><link rel="prefetch" href="/blog/assets/js/38.8ac342a8.js"><link rel="prefetch" href="/blog/assets/js/39.87f2d5bf.js"><link rel="prefetch" href="/blog/assets/js/4.8ace6b48.js"><link rel="prefetch" href="/blog/assets/js/41.41f89e92.js"><link rel="prefetch" href="/blog/assets/js/42.a975c6ee.js"><link rel="prefetch" href="/blog/assets/js/5.f6ae86c1.js"><link rel="prefetch" href="/blog/assets/js/6.934dda82.js"><link rel="prefetch" href="/blog/assets/js/8.c40fe45c.js"><link rel="prefetch" href="/blog/assets/js/9.2e2433d3.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.ad969224.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.5f88d1cd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Zhiting Li的博客</h3> <p class="description" data-v-59e6cb88>专注分享</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Zhiting Li</span>
          
        <!---->
        2024
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/th.jpg" alt="Zhiting Li的博客" class="logo"> <span class="site-name">Zhiting Li的博客</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link"><i class="undefined"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/生成模型/" class="nav-link"><i class="undefined"></i>
  生成模型
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/图形学/" class="nav-link"><i class="undefined"></i>
  图形学
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      Zhiting Li的博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/zhitingli/Notebook.git" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/blog/th.jpg" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    Zhiting Li
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>4</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>4</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link"><i class="undefined"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/生成模型/" class="nav-link"><i class="undefined"></i>
  生成模型
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/图形学/" class="nav-link"><i class="undefined"></i>
  图形学
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      Zhiting Li的博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/zhitingli/Notebook.git" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>3dgs原理及其代码</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Zhiting Li</span>
          
        <!---->
        2024
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page" style="padding-right:0;"><section style="display:;"><div class="page-title"><h1 class="title">3dgs原理及其代码</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>Zhiting Li</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2024/7/26</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>三维重建</span><span class="tag-item" data-v-8a445198>图形学</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="研究问题"><a href="#研究问题" class="header-anchor">#</a> 研究问题</h2> <ul><li>为什么3d gaussian是椭球？</li> <li>协方差矩阵为什么可以控制椭球的形状？</li> <li>协方差矩阵为什么可以用旋转和缩放矩阵表达？</li> <li>各向异性和各向同性是什么意思？</li> <li>为什么引入雅可比，这个雅可比矩阵是什么？</li> <li>球谐函数怎么就能更好地表达颜色？</li> <li>3dgs怎么就快了？</li></ul> <hr> <h2 id="总的框架"><a href="#总的框架" class="header-anchor">#</a> 总的框架</h2> <p>首先有一个初始化的点云，然后<strong>通过训练得到了高斯椭球的中心点</strong>，但是此时的高斯椭球没有形状也没有旋转方向。然后将高斯椭球的形状以及方向加入，就得到了带有形状大小以及旋转方向的信息的点云。最后加入不透明度的信息，就可以得到最后的渲染图片了。</p> <p><img src="C:%5CUsers%5Clizhi%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240624100048627.png" alt="image-20240624100048627"></p> <h3 id="伪代码"><a href="#伪代码" class="header-anchor">#</a> 伪代码</h3> <p><img src="C:%5CUsers%5Clizhi%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240624100537282.png" alt="image-20240624100537282"></p> <p>$M$：点云的位置，也就是均值$\mu$</p> <p>$V$：相机的位姿</p> <p>$\hat{I}$：ground-truth，数据集中的真实照片</p> <h3 id="_1-sfm初始化稀疏点云-视频转化成了空间位置"><a href="#_1-sfm初始化稀疏点云-视频转化成了空间位置" class="header-anchor">#</a> 1. sfm初始化稀疏点云：视频转化成了空间位置</h3> <p>第一步，要初始化稀疏点云，这一步采用了类似colmap的方式实现。通过一组照片，推理每一个照片对应的相机位姿，然后也能得到他们这一组照片里的每一个特征点，<strong>将这种特征点投射到世界坐标系中，就可以得到一些稀疏的关键点云</strong>。这些点云用作于3dgs一开始场景中的默认一些点。当然这个些点云是否能够直接初始化，也是可以的，但是最后收敛可能就没有那么快。所以他一般通过这种方式，先得到一组初始化点云。</p> <blockquote><h4 id="特征点"><a href="#特征点" class="header-anchor">#</a> 特征点</h4> <p><strong>图像的特征点的定义：</strong></p> <p>图像的特征点（Keypoints or Feature Points）是指图像中具有显著特征、易于识别且在各种变换（如旋转、缩放、光照变化等）下具有较高稳定性和可重复性的位置。</p> <p><strong>特征点的主要特点包括：</strong></p> <ol><li><strong>显著性</strong>：特征点应在图像中具有显著特征，易于从背景中分离出来。</li> <li><strong>可重复性</strong>：在不同的图像或不同的时间拍摄的同一场景中，特征点应能够被稳定地检测出来。</li> <li><strong>独特性</strong>：特征点应具备独特的描述子，使其在匹配过程中能够准确区分不同的点。</li></ol> <p><strong>为什么图像会具有特征点：</strong></p> <p>图像中的特征点之所以存在并且能被检测出来，是因为图像通常包含一些在视觉上突出的区域，这些区域在各种变换（如旋转、缩放、光照变化等）下能够保持稳定和可识别性。以下是一些原因和原理，解释了为什么图像会有特征点：</p> <ol><li>图像中的结构信息</li></ol> <p>特征点通常位于图像中具有丰富结构信息的区域，例如角点、边缘、纹理和突变区域。这些区域包含了图像的独特信息，有助于区别不同的部分。</p> <ol start="2"><li>不变性</li></ol> <p>有效的特征点具有不变性，即它们在各种图像变换下保持稳定。这意味着即使图像发生了旋转、缩放、光照变化或仿射变换，这些特征点仍然可以被检测和匹配。这种不变性使特征点在图像配准、拼接、三维重建等任务中非常有用。</p> <ol start="3"><li>视觉显著性</li></ol> <p>特征点通常是图像中视觉上显著的点。例如，在一个角点处，图像的梯度变化剧烈，这使得角点在视觉上很容易被识别和定位。同样，纹理丰富的区域往往包含许多可以作为特征点的显著变化。</p> <ol start="4"><li>算法特性</li></ol> <p>不同的特征点检测算法通过不同的方式识别图像中的特征点。以下是几种常见算法的特性：</p> <ul><li><strong>Harris 角点检测器</strong>：利用图像梯度的变化来检测角点，适用于识别图像中的角点。</li> <li><strong>SIFT（尺度不变特征变换）</strong>：通过检测尺度空间中的极值点来识别特征点，具有尺度和旋转不变性。</li> <li><strong>SURF（加速鲁棒特征）</strong>：改进了SIFT算法，使用Hessian矩阵来检测特征点，计算速度更快。</li> <li><strong>ORB（快速特征点检测和描述）</strong>：结合了FAST角点检测和BRIEF描述子，计算速度快，适用于实时应用。</li></ul> <ol start="5"><li>应用需求</li></ol> <p>在计算机视觉和图像处理的许多应用中，特征点是非常重要的。例如：</p> <ul><li><strong>图像匹配和配准</strong>：通过匹配不同图像中的特征点，可以对齐图像，进行拼接或全景图构建。</li> <li><strong>对象识别</strong>：特征点可以帮助识别和定位图像中的对象。</li> <li><strong>三维重建</strong>：通过匹配多幅图像中的特征点，可以恢复三维结构。</li></ul> <div class="language-python extra-class"><pre class="language-python"><code>原始图像                       旋转后的图像
<span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span>                   <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">|</span>         <span class="token operator">|</span>                   <span class="token operator">|</span>         <span class="token operator">|</span>
<span class="token operator">|</span>    ●    <span class="token operator">|</span>  <span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>旋转<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">&gt;</span>    <span class="token operator">|</span>    ●    <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token operator">/</span> \   <span class="token operator">|</span>                   <span class="token operator">|</span>   <span class="token operator">/</span> \   <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token operator">/</span>   \  <span class="token operator">|</span>                   <span class="token operator">|</span>  <span class="token operator">/</span>   \  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token operator">/</span>     \ <span class="token operator">|</span>                   <span class="token operator">|</span> <span class="token operator">/</span>     \ <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span>                   <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span>
</code></pre></div><p>上图中，特征点（●）在旋转后的图像中仍然保持其相对位置。</p></blockquote> <h3 id="_2-3d高斯椭球集的创建"><a href="#_2-3d高斯椭球集的创建" class="header-anchor">#</a> 2. 3D高斯椭球集的创建</h3> <h4 id="位置信息与形状信息"><a href="#位置信息与形状信息" class="header-anchor">#</a> 位置信息与形状信息</h4> <p>位置信息：即高斯椭球的中心点，就是均值$\mu$，用$(x,y,z)$表示，后续会不断通过优化这个得到更加精确的位置信息；</p> <p>形状信息：即<strong>高斯椭球</strong>的协方差矩阵$\Sigma$ ，其中$\Sigma=RSS^TR^T$，其包含了高斯椭球的<strong>旋转矩阵$R$<strong>以及各个轴的</strong>缩放矩阵$S$</strong>。（其实就是对一个标准的椭圆进行旋转再拉伸的过程）</p> <h4 id="颜色与不透明度"><a href="#颜色与不透明度" class="header-anchor">#</a> 颜色与不透明度</h4> <p>颜色信息：相对比较复杂，用到了球谐函数，而不是简单的RGB来表示</p> <p>不透明度：$\alpha$</p> <p><strong>球谐函数/系数</strong></p> <h5 id="基函数"><a href="#基函数" class="header-anchor">#</a> 基函数</h5> <p>定义：一组可以组成任意函数的分量。</p> <p>like 傅里叶变换以三角函数系
$$
{1,\sin(wx),\cos(wx),\sin(2wx),\cos(2wx),...,\sin(nwx),\cos(nwx)}
$$
作为基函数。任意一个函数$f(x)$都可以以三角函数为基进行傅里叶展开。</p> <p>因此有了基函数，就可以将一个任意的函数描述成基函数的加权和。</p> <h5 id="球面函数"><a href="#球面函数" class="header-anchor">#</a> 球面函数</h5> <p>通常表示为$f(\theta,\phi)$，其中$\theta$与$\phi$是球面坐标系中的两个角度的参数。球面函数的值再球面上的每个点都是唯一的，可以用于描述球面上的各种现象：温度分布、光照强度分布。</p> <h5 id="球谐函数-spherical-harmonics"><a href="#球谐函数-spherical-harmonics" class="header-anchor">#</a> 球谐函数（Spherical Harmonics）</h5> <p>可视化：<a href="https://www.bilibili.com/video/BV1tM4y1A7sC/?spm_id_from=333.337.search-card.all.click&amp;vd_source=d70106d2962096c1c0ffc161c8a03f66" target="_blank" rel="noopener noreferrer">球谐级数可视化_哔哩哔哩_bilibili<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>是最有名的球面上的基函数，并且具有很多很好的性质。</p> <p>可以看作一种多项式的拟合，就是一组可以<strong>表达球面值变化的基函数</strong>。球谐函数只与仰角$\theta$以及方位角$\phi$有关，与半径$r$无关。</p> <p>球谐函数记为$Y_l^m$：
$$
Y_l^m(\theta,\phi)=
\left{
\begin{aligned}
&amp;\sqrt2K_l^m\cos(m\phi)P_l^m(\cos\theta)&amp;(m&gt;0)\
&amp;\sqrt2K_l^m\cos(-m\phi)P_l^{-m}(\cos\theta)&amp;(m&lt;0)\
&amp;K_l^0P_l^0(\cos\theta)&amp;(m=0)
\end{aligned}
\right.
$$
其中，$l\in N$称为球谐函数的”次数“，$m\in [-l,l]$为球谐函数的”阶数“，$K_l^m$为一个缩放系数，$P_l^m(\cdot)$为勒让德多项式。</p> <p>各次数基函数的图：</p> <p><img src="https://yindaheng98.github.io/%E5%9B%BE%E5%BD%A2%E5%AD%A6/zhimg.com/v2-1ea9c5bac926b47e7410a4a73a91070a_r.jpg" alt="img"></p> <p>注意：从上到下次数增大，从左到右阶数增大；</p> <p>当SH的系数用的越多，那么球谐函数的表达能力就越强，跟原始的函数就会越接近：</p> <p><img src="https://yindaheng98.github.io/%E5%9B%BE%E5%BD%A2%E5%AD%A6/zhimg.com/v2-447fa3cffce97c4d95fd924c3e4ce5b9_r.jpg" alt="img"></p> <h5 id="球谐函数的应用"><a href="#球谐函数的应用" class="header-anchor">#</a> 球谐函数的应用</h5> <p>球谐函数可以用来记录某个值在球面上的分布情况，比如光照或者颜色的分布。</p> <ol><li><p>用平面表示一球坐标系函数，其中$r$表示半径，且$r=f(\theta,\phi)$：</p> <p><img src="https://yindaheng98.github.io/%E5%9B%BE%E5%BD%A2%E5%AD%A6/zhimg.com/v2-17b532bdb46a0d30b9eaf0e45f2df733_b.jpg" alt="img"></p></li> <li><p>假设$r$表示亮度，那么$r=f(\theta,\phi)$就表示一个球体上的高光情况：</p> <p><img src="https://yindaheng98.github.io/%E5%9B%BE%E5%BD%A2%E5%AD%A6/zhimg.com/v2-663f3ac6abb50526a2019acb0c1b28b0_r.jpg" alt="img"></p></li></ol> <p>原因：</p> <p>我们知道，三个球坐标系函数可以用来表示出球面上的不同位置的不同颜色（一个球坐标系可以表示一个特定的颜色，在RGB空间中需要有3个球函数表示）。而理论上任意一个球坐标系函数都可以分解为球谐函数的和，所以只需要记下球谐函数的系数就相当于记下了球面上的光照情况。</p> <ol start="3"><li><strong>球谐函数用不同角度的颜色表达，这在点云的渲染中非常有用。其中3dgs就是用球谐函数记录空间中的Gaussian点在不同方向的颜色。</strong></li></ol> <p>原因：</p> <p>假设我们有一个函数$f(\theta,\phi)$，它表示空间中某个点在方向$(\theta,\phi)$上的颜色信息。这个函数可以是 RGB 颜色空间的三个分量之一，如$f_r(\theta,\phi)$ 表示红色分量，$f_g(\theta,\phi)$表示绿色分量，$f_b(\theta,\phi)$ 表示蓝色分量。因此可以使用球谐展开将这个方向上的颜色信息表示为球谐函数的线性组合。</p> <p>意义：从不同的角度看高斯点云，可以呈现出不同的光泽</p> <p><img src="C:%5CUsers%5Clizhi%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240621175422502.png" alt="image-20240621175422502"></p> <h2 id="splatting"><a href="#splatting" class="header-anchor">#</a> Splatting</h2> <p>抛雪球算法的英文名称为splatting方法，也称为足迹法(Footprint)，它是<strong>反复对体素的投影叠加效果进行运算</strong>。</p> <p>它使用一个称为<strong>足迹的函数</strong>计算每一体素投影的影响范围，用<strong>高斯函数</strong>定义点或者小区域像素的强度分布，从而计算出其对图像的<strong>总体贡献</strong>，并加以合成，形成最后的图像。</p> <p>由于这个方法模仿了<strong>雪球被抛到墙壁上所留下的一个扩散状痕迹的现象，因而取名为“抛雪球法”</strong>：想象输入是一个雪球，图片是一面砖墙，图像生成的过程就是向墙面仍雪球的过程。在每扔一个雪球的过程中，墙面上就会有扩散的痕迹，称为足迹 footprint。</p> <h3 id="定义"><a href="#定义" class="header-anchor">#</a> <strong>定义：</strong></h3> <ul><li><p>是一种体渲染地方法，其可以把 3D 的物体渲染到 2D 的平面上</p></li> <li><p>Ray-casting是一种被动的（NeRf）</p> <ul><li>从一张图片的<strong>每个像素</strong>出发，找到影响这个像素的发光粒子，随后确定这个像素的RGB，即计算出每个像素点受到发光粒子的影响来生成图像；</li></ul></li> <li><p>Spatting是主动的（3dgs）</p> <ul><li>从粒子出发，<strong>每一个粒子</strong>会对像素造成影响，需要计算每个发光粒子如何影响像素点；</li></ul> <blockquote><ul><li><p>出自1990年一篇博士论文：https://www.cs.unc.edu/techreports/91-029.pdf</p> <p>特点：渲染效果快，但是效果一般</p></li> <li><p><strong>3dgs基于2001年的<em>EWA Volume Splatting https://ieeexplore.ieee.org/document/964490</em></strong></p></li></ul></blockquote></li></ul> <h3 id="算法核心"><a href="#算法核心" class="header-anchor">#</a> <strong>算法核心：</strong></h3> <p>① 选择【雪球】，选择每个特征点适合的雪球；</p> <p>② 抛掷雪球：是从 3D 投影到 2D，得到足迹；</p> <p>③ 加以合成，形成最后的图像；</p> <h3 id="step1-选择【雪球】"><a href="#step1-选择【雪球】" class="header-anchor">#</a> step1：选择【雪球】</h3> <p>模型的输入是点云中的一些点，这些点是没有体积的。因此需要对其进行膨胀，于是选择一个核进行膨胀。核的选择可以是高斯、可以是正方体也可以是圆。</p> <p>高斯椭球的定义：</p> <ul><li>椭球高斯：$G(x)=\frac{1}{\sqrt{(2\pi)^k |\Sigma|}}e^{-\frac{1}{2}(x-\mu)^T \Sigma^{-1}(x-\mu)}$</li></ul> <p><strong>为什么选择 3D 高斯椭球？</strong></p> <p>优秀的数学性质：</p> <ul><li><strong>仿射变换（本质是线性变换）后高斯核函数仍然闭合：3D 降维到 2D之后（沿着某一个轴积分），其仍然为高斯</strong></li></ul> <p>3D 高斯是一个概率，其为什么是一个椭球呢？</p> <p>椭球的函数：$\frac{x^2}{a^2}+\frac{y^2}{b^2}+\frac{z^2}{c^2}=1$</p> <p>由于高维的高斯分布与均值 $\mu$ 以及协方差矩阵 $\Sigma$ 决定，将$G(x)$的函数形式展开，就可以看出来是一个椭球函数的变换形式了。</p> <p>所以当$G(x;\mu,\Sigma)$在$[0,1]$变化的时候，形成了一个不断外扩的椭球壳，<strong>因此形成了一个实心的椭球。</strong></p> <p>因此3d Gaussian是一个实心的椭球，而不是一个椭球壳。</p> <p><strong>各向同性：</strong></p> <ul><li>在所有方向具有相同的扩散程度（梯度）</li> <li>比如 <strong>球</strong> 就是一个具有各向同性的存在，每个轴是不相关的；</li> <li>其协方差矩阵 $\Sigma=\begin{bmatrix} \sigma^2 &amp; 0 &amp;0 \ 0 &amp; \sigma^2 &amp;0\0 &amp;0 &amp;\sigma^2 \end{bmatrix} \quad$</li></ul> <p><strong>各向异性：</strong></p> <ul><li>在不同的方向具有不同的扩散程度</li> <li>比如 <strong>椭球</strong> 就是一个具有各向异性的存在，每个轴之间至少存在一组是相关的；</li> <li>协方差矩阵 $\Sigma=\begin{bmatrix} \sigma^2 &amp; \sigma_{xy} &amp;\sigma_{xz} \ \sigma_{yx} &amp; \sigma^2 &amp;\sigma_{yz}\\sigma_{zx} &amp;\sigma_{zy} &amp;\sigma^2 \end{bmatrix} \quad$</li></ul> <p><strong>协方差矩阵如何控制椭球的形状？</strong></p> <p>（其实就是高斯分布的线性变换）</p> <p>高斯分布：</p> <ul><li>$\boldsymbol{x} \sim N(\mu,\Sigma)$</li> <li>均为三维的，且不是标准的高斯分布</li></ul> <p><strong>高斯分布的仿射变换：</strong></p> <ul><li>$\boldsymbol{w}=A\boldsymbol{x}+b$</li> <li>$\boldsymbol{w}\sim N(A\mu +b,A\Sigma A^T)$</li></ul> <p><strong>因此可以通过控制 $A$ 的形状，可以将一个标准高斯分布仿射变换至任意一个高斯分布，因此协方差矩阵控制了椭球的形状</strong></p> <blockquote><p><strong>结论：任意高斯分布都可以看作是标准高斯分布通过仿射变换得到</strong>，而标准高斯是一个球，因此结论也可以称为：</p> <p>​	<strong>任意一个椭球都可以经过一个球的仿射变换得到</strong></p></blockquote> <p><strong>协方差矩阵为什么可以用旋转和缩放表达？</strong></p> <p>高斯分布的仿射变换：</p> <ul><li>$\boldsymbol{w}=A\boldsymbol{x}+b$</li> <li>$\boldsymbol{w}\sim N(A\mu +b,A\Sigma A^T)$</li></ul> <p>$A$ 本质上就是一个旋转矩阵 $R$ 与缩放矩阵 $S$的乘积，即$A=RS$ ，从而
$$
\Sigma&amp;=&amp;A\cdot I \cdot A^t \
&amp;=&amp; R \cdot S \cdot I \cdot S^T \cdot R^T\
&amp;=&amp; RSS^TR^T
$$
（对于$\Sigma$的分解可以用特征值分解）</p> <h3 id="step2-抛雪球"><a href="#step2-抛雪球" class="header-anchor">#</a> step2：抛雪球</h3> <p>框架：从3D 到 2D 像素的过程</p> <p><strong>参考：<a href="https://www.bilibili.com/video/BV1X7411F744/?spm_id_from=333.337.search-card.all.click" target="_blank" rel="noopener noreferrer">GAMES101-现代计算机图形学入门-闫令琪_哔哩哔哩_bilibili<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong></p> <p><strong>相机模型：坐标系之间的转换（NeRf)</strong></p> <ul><li>世界坐标系</li> <li>相机坐标系</li> <li>归一化坐标系</li> <li>像素坐标系</li></ul> <p><strong>CG模型</strong></p> <ul><li>观测变换：世界坐标系 $\rightarrow$ 相机坐标系</li> <li>投影变换：相机坐标系 $\rightarrow$ 2D的空间</li> <li>视口变换</li> <li>光栅化</li></ul> <h4 id="观测变换-从人眼的角度变成从相机的角度"><a href="#观测变换-从人眼的角度变成从相机的角度" class="header-anchor">#</a> 观测变换（从人眼的角度变成从相机的角度）</h4> <ul><li>世界坐标系 $\rightarrow$ 相机坐标系</li> <li>假如有一个高斯椭球，从不同的角度观察，这个高斯椭球可能有不同的形态</li> <li>本质还是仿射变换即 $\boldsymbol{w}=A\boldsymbol{x}+b$ 的过程</li></ul> <h5 id="_3d高斯的观测变换"><a href="#_3d高斯的观测变换" class="header-anchor">#</a> 3d高斯的观测变换</h5> <p>世界坐标系</p> <ul><li>高斯核中心：$\boldsymbol{t_k}=[t_0,t_1,t_2]^T$</li> <li>协方差矩阵：$V_k^{\prime\prime}$</li> <li>高斯核：$r_k^{\prime\prime}(t)=G_{V_k^{\prime\prime}}(t-t_k)$</li></ul> <p>相机坐标系：从世界坐标系的一个仿射变换</p> <ul><li>高斯核中心：$\boldsymbol{\mu_k}=[\mu_0,\mu_1,\mu_2]^T$</li> <li><strong>均值：$\boldsymbol{\mu_k}=W\cdot \boldsymbol{t_k}+d$</strong></li> <li><strong>协方差矩阵：$V_k^{\prime}=W\cdot V_k^{\prime\prime}\cdot W^T$</strong></li> <li>高斯核：$r_k^{\prime}(t)=G_{V_k^{\prime}}(\mu-\mu_k)$</li></ul> <p><img src="C:%5CUsers%5Clizhi%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240622205409044.png" alt="image-20240622205409044"></p> <h4 id="投影变换-从相机的角度映射到成像平面"><a href="#投影变换-从相机的角度映射到成像平面" class="header-anchor">#</a> 投影变换（从相机的角度映射到成像平面）</h4> <ul><li>3D $\rightarrow$ 2D</li> <li>正交投影：与深度 $z$ 无关，没有远小近大的情况，好处是处理更快（因为只与$x,y$有关）</li> <li>透视投影：考虑深度信息（符合人眼的成像原理）</li> <li>投影变换：将锥体压成立方体，然后将立方体再压成正方体</li></ul> <p><img src="https://yindaheng98.github.io/%E5%9B%BE%E5%BD%A2%E5%AD%A6/i/20231221222538.png" alt="img"></p> <p>正交投影：平移+缩放</p> <p>透视投影：压扁+平移+缩放，即先压缩再进行正交投影</p> <ul><li><strong>透视投影是非仿射变换（非线性的）</strong>，但我们希望高斯椭球一直进行仿射变换</li></ul> <h5 id="_3d高斯的投影变换"><a href="#_3d高斯的投影变换" class="header-anchor">#</a> 3d高斯的投影变换</h5> <p>相机坐标系：</p> <ul><li>高斯核中心：$\boldsymbol{\mu_k}=[\mu_0,\mu_1,\mu_2]^T$</li> <li>高斯核：$r_k^{\prime}(t)=G_{V_k^{\prime}}(\mu-\mu_k)$</li></ul> <p><strong>投影变换Ⅰ：</strong></p> <p>对于均值来说，是可以直接进行投影变换的，即$\boldsymbol{x_k}=m(\boldsymbol{\mu_k})$，其中$x=m(t)$表示非线性变换（均值只是一个点，并不会产生形变）；</p> <p>对于协方差来说，不可以直接使用投影变换，因为从透视投影到正交投影的过程中是非线性的，从而需要引入雅可比矩阵</p> <p><strong>为什么要使用雅可比矩阵（高维导数）</strong></p> <ul><li>泰勒展开</li> <li><strong>线性逼近：对非线性变换可以进行局部的线性逼近</strong></li></ul> <p>非线性变换：</p> <p>设对$[x,y]^T$进行非线性的坐标变换：
$$
f_1(x)=x+\sin(y)\
f_2(y)=y+\sin(x)
$$
即由$\begin{bmatrix} x \ y \end{bmatrix} \quad \rightarrow \begin{bmatrix} f_1(x) \ f_2(y) \end{bmatrix} \quad$</p> <p>雅可比矩阵：</p> <ul><li>$J=\begin{bmatrix} \frac{df_1}{dx} &amp; \frac{df_1}{dy} \ \frac{df_2}{dx} &amp; \frac{df_2}{dy}  \end{bmatrix} \quad$</li></ul> <p><strong>投影变换Ⅱ：</strong></p> <p>由于无法直接对协方差进行投影变换，因此使用雅可比矩阵对该非线性变换进行线性变换的模拟变换，实施方式如下：</p> <ul><li>由$\boldsymbol{x_k}=m(\boldsymbol{\mu_k})$</li> <li>求得每一个点的雅可比矩阵 $J=\frac{\partial m(\mu_k)}{\partial \mu}$</li> <li>于是协方差矩阵为 $V_k=J\cdot V_k^{\prime} \cdot J^T=J\cdot W \cdot V_k^{\prime\prime}\cdot W^T\cdot J^T$，对于协方差而言、此时的雅可比矩阵就是仿射变换矩阵，因此只是将锥形压扁，而没有继续进行平移+压缩变换</li></ul> <p>注意：</p> <p>经过投影变换中，均值被变换到了$[-1,1]^3$的范围当中，因此其需要做视口变换；</p> <p>然而协方差矩阵在未进行放缩的正交坐标系当时，并不在$[-1,1]^3$的范围当中，其不需要做视口变换；</p> <p><strong>投影变换的雅可比矩阵是什么</strong></p> <p>参考案例【较真系列】讲人话-3d gaussian splatting全解(原理+代码+公式)【2】 抛雪球-哔哩哔哩】 https://b23.tv/1FiTpns</p> <p>17分 18秒</p> <h4 id="视口变换-即拉伸变换-作用"><a href="#视口变换-即拉伸变换-作用" class="header-anchor">#</a> 视口变换，即拉伸变换（作用？）</h4> <ul><li>对投影变换的物体进行拉伸变换，与深度$z$无关</li> <li>将$[-1,1]\times [-1,1]$的矩阵变换至$[0,w]\times [0,h]$</li> <li>解决了在投影变换中由立方体 $\rightarrow$ 正方体的形变问题</li></ul> <h5 id="_3d高斯的视口变换"><a href="#_3d高斯的视口变换" class="header-anchor">#</a> 3d高斯的视口变换</h5> <p>只需要对均值进行一个视口变换</p> <p>投影变换后：</p> <ul><li>核中心$\boldsymbol{x_k}=[x_0,x_1,x_2]^T$</li> <li>高斯核：$r_k(x)=G_{V_k}(x-x_k)$</li></ul> <p>像素坐标系：</p> <ul><li><p>核中心$\boldsymbol{\mu}=[\mu_1,\mu_2,\mu_3]^T$</p> <ul><li>由$\boldsymbol{x_k}=[x_0,x_1,x_2]^T$平移以及缩放得到</li></ul></li> <li><p>协方差：进行足迹的渲染（离散计算），距离均值越近、其值越大</p> <ul><li>$G(\tilde{x})=\exp(-\frac{1}{2}(x-\mu)^TV_k^{-1}(x-\mu))$，还是一个高斯分布</li></ul></li></ul> <h4 id="光栅化"><a href="#光栅化" class="header-anchor">#</a> 光栅化</h4> <p>定义：</p> <ul><li>把东西画在屏幕上</li> <li>将连续的东西打成离散的东西</li> <li>方法：采样
<ul><li>像素是整数的，且每个像素都有一个中心点。观察中心点是否落在面片中
<ul><li>如果中心点落在面片中，这个像素就被点亮</li> <li>否则，像素就没有被点亮</li></ul></li> <li>经过这个操作，就可以知道哪些像素点被点亮，于是就可以进行涂色操作，于是完成了从连续空间到离散空间的转换</li></ul></li></ul> <h3 id="step3-合成雪球"><a href="#step3-合成雪球" class="header-anchor">#</a> step3：合成雪球</h3> <h4 id="雪球的颜色"><a href="#雪球的颜色" class="header-anchor">#</a> 雪球的颜色</h4> <p>球谐函数：</p> <ul><li>定义：任何一个<strong>球面坐标的函数</strong>（函数值与点上的方向有关）都可以用多个球谐函数近似</li> <li>$f(t)=\sum_l \sum_{m=-l}^l c_l^my_l^m(\theta,\phi)$</li> <li>$c_l^m$都是三维的，为了可以表示出RGB</li></ul> <p><strong>为什么球谐函数可以更好地表达颜色？</strong></p> <ul><li>（直观）正常用RGB三个数表达颜色（1*3的矩阵），但是用球谐函数就可以得到16*3的一个矩阵，因此数据的数量多、纬度高，从而可以存储的信息就会更多；</li> <li>在CG的渲染环境中，通常会用到环境贴图，而环境贴图通常会用到球形的环境贴图。
<ul><li>在渲染的环境中，用球谐函数重建亮度</li> <li>1阶到6阶，当球谐函数的阶数越高，还原的效果会更好。</li></ul></li></ul> <p>由此就得到了一个雪球的形成过程，那么接下来就是将多个雪球进行一个合成，即合成图片</p> <h4 id="合成图片"><a href="#合成图片" class="header-anchor">#</a> 合成图片</h4> <p>$\alpha$-blending进行足迹合成</p> <p>如何求像素的颜色？</p> <p>然后基于每一个像素求颜色</p> <p>方式：（NeRf）根据那个公式进行求解</p> <p>那3dgs为什么更快呢？</p> <ul><li>splatting没有找粒子的过程</li> <li>其只需要对高斯椭球按照深度z进行排序</li></ul> <p>如何将光线上粒子的颜色进行求和？</p> <h4 id="如何训练gaussian点参数"><a href="#如何训练gaussian点参数" class="header-anchor">#</a> 如何训练Gaussian点参数</h4> <p>按照论文中的定义，Gaussian点的参数只有$\Sigma$，其决定了椭球的形状和对称轴方向，不决定椭球的位置。 椭球的位置有另外的训练方法。</p> <p>训练过程就是用渲染图和原图比较计算视野中高斯点的矩阵$\Sigma$的梯度，然后梯度下降调$\Sigma$。<strong>（与论文中的基于梯度自适应改变点云的分布有关）</strong></p> <p>其梯度计算原理比较复杂，需学习<a href="https://yindaheng98.github.io/%E5%9B%BE%E5%BD%A2%E5%AD%A6/3D%E9%AB%98%E6%96%AF%E6%95%B0%E5%AD%A6%E6%8E%A8%E5%AF%BC.html" target="_blank" rel="noopener noreferrer">《3D Gaussian Splatting中的数学推导》<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，相关方法主要来自于论文 Matthias Zwicker, Hanspeter Pfister, Jeroen Van Baar, and Markus Gross. 2001a. <strong>EWA volume splatting</strong>. <em>In Proceedings Visualization</em>, 2001. VIS’01. IEEE, 29–538.</p> <h4 id="如何训练gaussian点位置"><a href="#如何训练gaussian点位置" class="header-anchor">#</a> 如何训练Gaussian点位置</h4> <p>文中只提了一嘴“位置梯度”但是没有细讲，不知道具体什么实现。 但是可以参考另一篇基于EWA Splatting的文章《Differentiable surface splatting for point-based geometry processing》。</p> <h3 id="各迭代参数"><a href="#各迭代参数" class="header-anchor">#</a> 各迭代参数</h3> <p>位置信息：$(x,y,z)$，即中心点信息</p> <p>法向量信息：$(nx,ny,nz)$，即光照</p> <p>颜色信息：用了4阶的球谐函数，一共48个参数，SH系数$(f_dc_0,f_dc_1,f_dc_2)$，以及$(f_rest_0,...,f_rest_44)$</p> <p>不透明度：opacity, $\alpha$</p> <p>缩放矩阵：$(scale_0,scale_1,scale_2)$</p> <p>旋转矩阵：$(rot_0,rot_1,rot_2)$</p> <h3 id="如何迭代-基于梯度自适应改变点云的分布方式"><a href="#如何迭代-基于梯度自适应改变点云的分布方式" class="header-anchor">#</a> 如何迭代：基于梯度自适应改变点云的分布方式</h3> <h4 id="如何增加gaussian点"><a href="#如何增加gaussian点" class="header-anchor">#</a> 如何增加Gaussian点</h4> <p>方式：重新采样</p> <p>标准：（基于梯度的变化判断）</p> <p>梯度很大，说明高斯椭球与要拟合的形体差异很大，因此需要判断形体的差异大来源于方差小 / 方差大</p> <ol><li>过度重构的：方差很大，因此可以分成两个高斯</li> <li>欠采样：方差太小，克隆高斯以适应</li></ol> <h4 id="如何减少gaussian点"><a href="#如何减少gaussian点" class="header-anchor">#</a> 如何减少Gaussian点</h4> <p>目的：</p> <ul><li>删除不重要的Gaussian点以减小计算量；</li> <li>应对相机面前的错误点（floaters close to the input cameras）</li></ul> <p>方法：</p> <ul><li>删除不重要的Gaussian点以减小计算量：在训练过程中会有一些Gaussian点的透明度不断下降到小于给定阈值，这些Gaussian点在训练过程中被删除；</li> <li>应对相机面前的错误点：
<ol><li>每个一段时间就将Gaussian点的透明度设为0；</li> <li>禁用点的增加和移动功能，仅对Gaussian点的参数进行一段时间训练；
<ul><li>有些Gaussian点会在训练过程中变大，覆盖住其他点或者盖住相机，进而删除这些点；</li></ul></li> <li>训练完成后会有一些Gaussian点透明度仍然接近0，删除这些点；</li></ol></li></ul> <blockquote><h4 id="相机面前的错误点-floaters-close-to-the-input-cameras-是什么"><a href="#相机面前的错误点-floaters-close-to-the-input-cameras-是什么" class="header-anchor">#</a> 相机面前的错误点(floaters close to the input cameras)是什么</h4> <p>理论上讲，在每个输入视角面前摆上输入图片，就可以让NeRF训练误差降到0。 这也是NeRF的一种过拟合，正因为如此，NeRF在训练过程中会有概率在输入视角附近训练出一些错误点。 尤其是在相机参数的有误差的时候，输入图像上的某些点时无解的，这是如果用DNN较大的NeRF进行过度的训练，NeRF不管怎么样都没法在场景中找到某些点的最优解，就会将点放在相机面前。</p></blockquote> <h2 id="_3d高斯的代码框架"><a href="#_3d高斯的代码框架" class="header-anchor">#</a> 3D高斯的代码框架</h2> <p>主要的代码框架即两个：由“点云”经过“Rasterization”生成“图片”，由“loss”根据反向梯度传播进行微分优化。并且其并没有使用神经网络结构，核心代码是C++，因此主要目的在于跑通这个代码，并且用自己的数据集跑通。</p> <p>首次用自己的数据集跑通，难点在于1. colmap的linux安装；2. 远程可视化，但实际上回头看发现只是熟练度的问题，因此在后面的NeRF的实验中也存在这个问题。</p> <p>核心代码在<code>submodules/diff-gaussian-rasterization</code>.Rasterization 和 Differential 分别是<code>forward</code>和<code>backward</code>过程。</p> <div class="language-C++ extra-class"><pre class="language-text"><code>#
# Copyright (C) 2023, Inria
# GRAPHDECO research group, https://team.inria.fr/graphdeco
# All rights reserved.
#
# This software is free for non-commercial, research and evaluation use 
# under the terms of the LICENSE.md file.
#
# For inquiries contact  george.drettakis@inria.fr
#

from typing import NamedTuple
import torch.nn as nn
import torch
from . import _C

def cpu_deep_copy_tuple(input_tuple):
    copied_tensors = [item.cpu().clone() if isinstance(item, torch.Tensor) else item for item in input_tuple]
    return tuple(copied_tensors)

def rasterize_gaussians(
    means3D,
    means2D,
    sh,
    colors_precomp,
    opacities,
    scales,
    rotations,
    cov3Ds_precomp,
    raster_settings,
):
    return _RasterizeGaussians.apply(
        means3D,
        means2D,
        sh,
        colors_precomp,
        opacities,
        scales,
        rotations,
        cov3Ds_precomp,
        raster_settings,
    )

class _RasterizeGaussians(torch.autograd.Function):
    @staticmethod
    def forward(
        ctx,
        means3D,
        means2D,
        sh,
        colors_precomp,
        opacities,
        scales,
        rotations,
        cov3Ds_precomp,
        raster_settings,
    ):

        # Restructure arguments the way that the C++ lib expects them
        args = (
            raster_settings.bg, 
            means3D,
            colors_precomp,
            opacities,
            scales,
            rotations,
            raster_settings.scale_modifier,
            cov3Ds_precomp,
            raster_settings.viewmatrix,
            raster_settings.projmatrix,
            raster_settings.tanfovx,
            raster_settings.tanfovy,
            raster_settings.image_height,
            raster_settings.image_width,
            sh,
            raster_settings.sh_degree,
            raster_settings.campos,
            raster_settings.prefiltered,
            raster_settings.debug
        )

        # Invoke C++/CUDA rasterizer
        if raster_settings.debug:
            cpu_args = cpu_deep_copy_tuple(args) # Copy them before they can be corrupted
            try:
                num_rendered, color, radii, geomBuffer, binningBuffer, imgBuffer = _C.rasterize_gaussians(*args)
            except Exception as ex:
                torch.save(cpu_args, &quot;snapshot_fw.dump&quot;)
                print(&quot;\nAn error occured in forward. Please forward snapshot_fw.dump for debugging.&quot;)
                raise ex
        else:
            num_rendered, color, radii, geomBuffer, binningBuffer, imgBuffer = _C.rasterize_gaussians(*args)

        # Keep relevant tensors for backward
        ctx.raster_settings = raster_settings
        ctx.num_rendered = num_rendered
        ctx.save_for_backward(colors_precomp, means3D, scales, rotations, cov3Ds_precomp, radii, sh, geomBuffer, binningBuffer, imgBuffer)
        return color, radii

    @staticmethod
    def backward(ctx, grad_out_color, _):

        # Restore necessary values from context
        num_rendered = ctx.num_rendered
        raster_settings = ctx.raster_settings
        colors_precomp, means3D, scales, rotations, cov3Ds_precomp, radii, sh, geomBuffer, binningBuffer, imgBuffer = ctx.saved_tensors

        # Restructure args as C++ method expects them
        args = (raster_settings.bg,
                means3D, 
                radii, 
                colors_precomp, 
                scales, 
                rotations, 
                raster_settings.scale_modifier, 
                cov3Ds_precomp, 
                raster_settings.viewmatrix, 
                raster_settings.projmatrix, 
                raster_settings.tanfovx, 
                raster_settings.tanfovy, 
                grad_out_color, 
                sh, 
                raster_settings.sh_degree, 
                raster_settings.campos,
                geomBuffer,
                num_rendered,
                binningBuffer,
                imgBuffer,
                raster_settings.debug)

        # Compute gradients for relevant tensors by invoking backward method
        if raster_settings.debug:
            cpu_args = cpu_deep_copy_tuple(args) # Copy them before they can be corrupted
            try:
                grad_means2D, grad_colors_precomp, grad_opacities, grad_means3D, grad_cov3Ds_precomp, grad_sh, grad_scales, grad_rotations = _C.rasterize_gaussians_backward(*args)
            except Exception as ex:
                torch.save(cpu_args, &quot;snapshot_bw.dump&quot;)
                print(&quot;\nAn error occured in backward. Writing snapshot_bw.dump for debugging.\n&quot;)
                raise ex
        else:
             grad_means2D, grad_colors_precomp, grad_opacities, grad_means3D, grad_cov3Ds_precomp, grad_sh, grad_scales, grad_rotations = _C.rasterize_gaussians_backward(*args)

        grads = (
            grad_means3D,
            grad_means2D,
            grad_sh,
            grad_colors_precomp,
            grad_opacities,
            grad_scales,
            grad_rotations,
            grad_cov3Ds_precomp,
            None,
        )

        return grads

class GaussianRasterizationSettings(NamedTuple):
    image_height: int
    image_width: int 
    tanfovx : float
    tanfovy : float
    bg : torch.Tensor
    scale_modifier : float
    viewmatrix : torch.Tensor
    projmatrix : torch.Tensor
    sh_degree : int
    campos : torch.Tensor
    prefiltered : bool
    debug : bool

class GaussianRasterizer(nn.Module):
    def __init__(self, raster_settings):
        super().__init__()
        self.raster_settings = raster_settings

    def markVisible(self, positions):
        # Mark visible points (based on frustum culling for camera) with a boolean 
        with torch.no_grad():
            raster_settings = self.raster_settings
            visible = _C.mark_visible(
                positions,
                raster_settings.viewmatrix,
                raster_settings.projmatrix)
            
        return visible

    def forward(self, means3D, means2D, opacities, shs = None, colors_precomp = None, scales = None, rotations = None, cov3D_precomp = None):
        
        raster_settings = self.raster_settings

        if (shs is None and colors_precomp is None) or (shs is not None and colors_precomp is not None):
            raise Exception('Please provide excatly one of either SHs or precomputed colors!')
        
        if ((scales is None or rotations is None) and cov3D_precomp is None) or ((scales is not None or rotations is not None) and cov3D_precomp is not None):
            raise Exception('Please provide exactly one of either scale/rotation pair or precomputed 3D covariance!')
        
        if shs is None:
            shs = torch.Tensor([])
        if colors_precomp is None:
            colors_precomp = torch.Tensor([])

        if scales is None:
            scales = torch.Tensor([])
        if rotations is None:
            rotations = torch.Tensor([])
        if cov3D_precomp is None:
            cov3D_precomp = torch.Tensor([])

        # Invoke C++/CUDA rasterization routine
        return rasterize_gaussians(
            means3D,
            means2D,
            shs,
            colors_precomp,
            opacities,
            scales, 
            rotations,
            cov3D_precomp,
            raster_settings, 
        )
</code></pre></div></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:0;" data-v-b57cc07c data-v-7dd95ae2></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/blog/assets/js/app.831d1050.js" defer></script><script src="/blog/assets/js/7.7a792a4f.js" defer></script><script src="/blog/assets/js/2.01b6400f.js" defer></script><script src="/blog/assets/js/1.0e32e396.js" defer></script><script src="/blog/assets/js/40.abf7f79c.js" defer></script>
  </body>
</html>
